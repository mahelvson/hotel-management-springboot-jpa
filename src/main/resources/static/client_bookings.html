<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .navbar {
        background-color: #343a40 !important;
      }
      .login-container {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }
      .main-content {
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .reservation-card {
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
      }
    </style>
    <title>Minhas Reservas</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Reserva de Hotel</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div id="userDetails" class="ms-auto">
            <span id="username" class="text-white me-2"></span>
            <button id="logoutButton" class="btn btn-outline-light">Sair</button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <h2>Minhas Reservas</h2>
      <div id="reservationsContainer" class="mt-4"></div>
    </div>

    <script>
      function displayUserInfo(user) {
        document.getElementById("username").textContent = user.name;
        document
          .getElementById("logoutButton")
          .addEventListener("click", () => {
            localStorage.removeItem("user");
            window.location.href = "/logout";
          });
      }

      async function fetchUserReservations() {
        try {
          const user = JSON.parse(localStorage.getItem("user"));
          if (!user) {
            alert("Usuário não autenticado. Por favor, faça login.");
            window.location.href = "/login";
            return;
          }

          displayUserInfo(user);

          const response = await fetch(`/bookings/user/${user.id}`);
          if (response.ok) {
            const reservations = await response.json();
            displayReservations(reservations);
          } else {
            console.error("Erro ao buscar reservas.");
          }
        } catch (error) {
          console.error("Erro ao buscar reservas do usuário:", error);
        }
      }

      function displayReservations(reservations) {
        const container = document.getElementById("reservationsContainer");
        container.innerHTML = "";

        if (reservations.length === 0) {
          container.innerHTML = "<p>Você não possui reservas ativas.</p>";
          return;
        }

        reservations.forEach((reservation) => {
          const card = document.createElement("div");
          card.classList.add("reservation-card");

          card.innerHTML = `
            <h5>Hotel: ${reservation.room.hotel.name}</h5>
            <p><strong>Quarto Número:</strong> ${reservation.room.roomNumber}</p>
            <p><strong>Check-In:</strong> <input type="date" id="checkIn-${reservation.id}" value="${reservation.dateCheckIn}" /></p>
            <p><strong>Check-Out:</strong> <input type="date" id="checkOut-${reservation.id}" value="${reservation.dateCheckOut}" /></p>
            <p><strong>Total Pago:</strong> R$${reservation.total}</p>
            <p><strong>Status:</strong> ${reservation.bookingStatus}</p>
            <button class="btn btn-warning btn-sm" onclick="updateReservation(${reservation.id}, ${reservation.room.id})">Atualizar</button>
            <button class="btn btn-danger btn-sm" onclick="deleteReservation(${reservation.id})">Excluir</button>
          `;

          container.appendChild(card);
        });
      }

      async function updateReservation(bookingId, roomId) {
        const checkIn = document.getElementById(`checkIn-${bookingId}`).value;
        const checkOut = document.getElementById(`checkOut-${bookingId}`).value;

        if (new Date(checkIn) >= new Date(checkOut)) {
          alert("A data de Check-In deve ser anterior à data de Check-Out.");
          return;
        }

        try {
          const response = await fetch(`/bookings?bookingId=${bookingId}&roomId=${roomId}&checkIn=${checkIn}&checkOut=${checkOut}`, {
            method: "PATCH",
          });

          if (response.ok) {
            alert("Reserva atualizada com sucesso!");
            fetchUserReservations();
          } else {
            alert("Erro ao atualizar a reserva.");
          }
        } catch (error) {
          console.error("Erro ao atualizar a reserva:", error);
          alert("Erro ao atualizar a reserva.");
        }
      }

      async function deleteReservation(bookingId) {
        if (!confirm("Tem certeza de que deseja excluir esta reserva?")) return;

        try {
          const response = await fetch(`/bookings/delete/${bookingId}`, {
            method: "DELETE",
          });

          if (response.ok) {
            alert("Reserva excluída com sucesso!");
            fetchUserReservations();
          } else {
            alert("Erro ao excluir a reserva.");
          }
        } catch (error) {
          console.error("Erro ao excluir a reserva:", error);
          alert("Erro ao excluir a reserva.");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user) {
          displayUserInfo(user);
          fetchUserReservations();
        } else {
          window.location.href = "/login";
        }
      });
    </script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
  </body>
</html>
