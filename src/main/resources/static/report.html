<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Relatório de Reservas e Gerenciamento de Quartos</title>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #343a40 !important;
        }
        .main-content {
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }
        .highlight {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Reserva de Hotel</a>
            <div id="userDetails" class="ms-auto text-white">
                <span id="username" class="me-3"></span>
                <button id="logoutButton" class="btn btn-outline-light btn-sm">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <h2 class="text-center">Relatório de Reservas e Gerenciamento de Quartos</h2>

        <!-- Seção de Relatório de Reservas -->
        <div class="mb-3">
            <label for="bookingId" class="form-label">ID da Reserva</label>
            <input type="number" id="bookingId" class="form-control" placeholder="Digite o ID da reserva" required>
            <button id="fetchReportBtn" class="btn btn-primary mt-2">Obter Relatório</button>
        </div>

        <div id="reportContainer" class="highlight d-none">
            <h4>Detalhes da Reserva</h4>
            <p><strong>ID da Reserva:</strong> <span id="reportId"></span></p>
            <p><strong>Nome do Cliente:</strong> <span id="clientName"></span></p>
            <p><strong>Email do Cliente:</strong> <span id="clientEmail"></span></p>
            <p><strong>Data de Check-In:</strong> <span id="checkInDate"></span></p>
            <p><strong>Data de Check-Out:</strong> <span id="checkOutDate"></span></p>
            <p><strong>Total da Reserva:</strong> R$<span id="totalAmount"></span></p>
            <p><strong>Número do Quarto:</strong> <span id="roomNumber"></span></p>
            <p><strong>Status do Pagamento:</strong> <span id="paymentStatus"></span></p>
            <p><strong>Método de Pagamento:</strong> <span id="paymentMethod"></span></p>
        </div>

        <!-- Seção de Gerenciamento de Quartos -->
        <div class="highlight mt-4">
            <h4>Gerenciamento de Quartos</h4>
            <!-- Formulário para Criar Novo Quarto -->
            <h5>Criar Novo Quarto</h5>
            <form id="createRoomForm">
                <div class="mb-3">
                    <label for="hotelName" class="form-label">Nome do Hotel</label>
                    <input type="text" id="hotelName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="roomNumber" class="form-label">Número do Quarto</label>
                    <input type="number" id="roomNumber" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="capacity" class="form-label">Capacidade</label>
                    <input type="number" id="capacity" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="singleBeds" class="form-label">Camas de Solteiro</label>
                    <input type="number" id="singleBeds" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="coupleBeds" class="form-label">Camas de Casal</label>
                    <input type="number" id="coupleBeds" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="diaryValue" class="form-label">Preço por Diária</label>
                    <input type="number" step="0.01" id="diaryValue" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-success">Criar Quarto</button>
            </form>

            <!-- Tabela para Visualizar Quartos -->
            <div class="mt-4">
                <h5>Quartos Cadastrados</h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Hotel</th>
                            <th>Número</th>
                            <th>Capacidade</th>
                            <th>Camas de Solteiro</th>
                            <th>Camas de Casal</th>
                            <th>Preço</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="roomTableBody">
                        <!-- Os quartos serão preenchidos dinamicamente via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fetchReportBtn = document.getElementById('fetchReportBtn');
            const createRoomForm = document.getElementById('createRoomForm');

            fetchReportBtn.addEventListener('click', fetchReport);
            createRoomForm.addEventListener('submit', createRoom);
            fetchRooms();
            fetchCurrentUser();

            function fetchReport() {
                const bookingId = document.getElementById('bookingId').value;
                if (!bookingId) {
                    alert('Por favor, insira um ID de reserva válido.');
                    return;
                }
                fetch(`/reports/booking/${bookingId}`)
                    .then(response => response.json())
                    .then(report => displayReport(report))
                    .catch(error => {
                        console.error('Erro ao buscar o relatório:', error);
                        alert('Erro ao buscar o relatório.');
                    });
            }

            function displayReport(report) {
                document.getElementById('reportId').textContent = report.id;
                document.getElementById('clientName').textContent = report.clientName;
                document.getElementById('clientEmail').textContent = report.clientEmail;
                document.getElementById('checkInDate').textContent = report.dateCheckIn;
                document.getElementById('checkOutDate').textContent = report.dateCheckOut;
                document.getElementById('totalAmount').textContent = report.totalAmount.toFixed(2);
                document.getElementById('roomNumber').textContent = report.roomNumber;
                document.getElementById('paymentStatus').textContent = report.paymentStatus;
                document.getElementById('paymentMethod').textContent = report.paymentMethod;

                document.getElementById('reportContainer').classList.remove('d-none');
            }

            async function fetchRooms() {
                try {
                    const response = await fetch("/rooms");
                    if (response.ok) {
                        const rooms = await response.json();
                        displayRooms(rooms);
                    } else {
                        alert('Erro ao buscar quartos.');
                    }
                } catch (error) {
                    console.error('Erro ao buscar quartos:', error);
                }
            }

            function displayRooms(rooms) {
                const roomTableBody = document.getElementById("roomTableBody");
                roomTableBody.innerHTML = "";

                rooms.forEach(room => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${room.id}</td>
                        <td>${room.hotel.name}</td>
                        <td>${room.roomNumber}</td>
                        <td>${room.capacity}</td>
                        <td>${room.singleBeds}</td>
                        <td>${room.coupleBeds}</td>
                        <td>R$${room.diaryValue.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="updateRoom(${room.id})">Alterar</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRoom(${room.id})">Remover</button>
                        </td>
                    `;
                    roomTableBody.appendChild(row);
                });
            }

            async function createRoom(event) {
                event.preventDefault();

                const hotelName = document.getElementById("hotelName").value.trim();
                const roomNumber = document.getElementById("roomNumber").value.trim();
                const capacity = document.getElementById("capacity").value.trim();
                const singleBeds = document.getElementById("singleBeds").value.trim();
                const coupleBeds = document.getElementById("coupleBeds").value.trim();
                const diaryValue = document.getElementById("diaryValue").value.trim();

                try {
                    const response = await fetch(`/rooms?hotelName=${hotelName}&roomNumber=${roomNumber}&capacity=${capacity}&singleBeds=${singleBeds}&coupleBeds=${coupleBeds}&diaryValue=${diaryValue}`, {
                        method: "POST"
                    });

                    if (response.ok) {
                        alert("Quarto cadastrado com sucesso!");
                        fetchRooms();
                        createRoomForm.reset();
                    } else {
                        alert("Erro ao cadastrar o quarto.");
                    }
                } catch (error) {
                    console.error('Erro ao criar quarto:', error);
                    alert("Erro ao criar quarto.");
                }
            }

            async function deleteRoom(roomId) {
                if (!confirm("Deseja realmente remover este quarto?")) return;

                try {
                    const response = await fetch(`/rooms/deteByNameNumber?roomId=${roomId}`, {
                        method: "DELETE"
                    });

                    if (response.ok) {
                        alert("Quarto removido com sucesso!");
                        fetchRooms();
                    } else {
                        alert("Erro ao remover o quarto.");
                    }
                } catch (error) {
                    console.error("Erro ao remover o quarto:", error);
                    alert("Erro ao remover o quarto.");
                }
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMF6Qa0fP6WU8L8fQ7UJ4F2JpGnJ4N6F7+VOMeNE5B/n/tlgbF42MO4IvJ" crossorigin="anonymous"></script>
</body>
</html>
